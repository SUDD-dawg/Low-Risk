<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eligibility Calculator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='eligibility.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='home-icon.css') }}">
  <style>
    .field-error {
      color: #d32f2f;
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }
    
    .form-error {
      color: #d32f2f;
      background-color: #ffebee;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #f44336;
    }
    
    input.error {
      border-color: #f44336 !important;
      background-color: #ffebee !important;
    }
    
    .validation-hint {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      display: block;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>ELIGIBILITY CALCULATOR</h1>
  
  <div class="form-box">
    <form method="POST" action="/eligibility" id="eligibilityForm">
      
      <div class="input-group">
        <label for="income">Monthly Income ($):</label>
        <input type="number" 
               name="income" 
               id="income"
               required 
               min="0" 
               max="1000000" 
               step="0.01"
               placeholder="e.g., 5000"
               value="{{ request.form.income or '' }}">
        <div class="validation-hint">Enter your monthly take-home pay (0-1,000,000)</div>
      </div>
      
      <div class="input-group">
        <label for="loan">Loan Amount Required ($):</label>
        <input type="number" 
               name="loan" 
               id="loan"
               required 
               min="0" 
               max="5000000" 
               step="0.01"
               placeholder="e.g., 200000"
               value="{{ request.form.loan or '' }}">
        <div class="validation-hint">Total loan amount you need (0-5,000,000)</div>
      </div>
      
      <div class="input-group">
        <label for="deposit">Available Deposit ($):</label>
        <input type="number" 
               name="deposit" 
               id="deposit"
               required 
               min="0" 
               max="1000000" 
               step="0.01"
               placeholder="e.g., 20000"
               value="{{ request.form.deposit or '' }}">
        <div class="validation-hint">Cash available for deposit (0-1,000,000)</div>
      </div>
      
      <div class="input-group">
        <label for="expenses">Monthly Expenses ($):</label>
        <input type="number" 
               name="expenses" 
               id="expenses"
               required 
               min="0" 
               max="50000" 
               step="0.01"
               placeholder="e.g., 2000"
               value="{{ request.form.expenses or '' }}">
        <div class="validation-hint">Your monthly living expenses (0-50,000)</div>
      </div>
      
      <button type="submit">Calculate Eligibility</button>
    </form>

    {% if error %}
    <div class="form-error">
      <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if eligible is not none %}
    <div class="result-box">
      {% if eligible %}
        <div class="eligible">
          <h2>✓ ELIGIBLE</h2>
          <p>Congratulations! You are eligible for the loan.</p>
          <p>Maximum loan amount: ${{ "{:,.2f}".format(max_loan) }}</p>
        </div>
      {% else %}
        <div class="not-eligible">
          <h2>✗ NOT ELIGIBLE</h2>
          <p>Sorry, you are not eligible for the loan at this time.</p>
          <p>Maximum loan amount you could qualify for: ${{ "{:,.2f}".format(max_loan) }}</p>
        </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <a href="/" class="home-link">
    <img src="{{ url_for('static', filename='25694.png') }}" alt="Home" class="home-icon">
  </a>

  <script>
    // Enhanced client-side validation
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('eligibilityForm');
      const inputs = form.querySelectorAll('input[type="number"]');
      
      // Validation rules
      const rules = {
        income: { min: 0, max: 1000000, required: true },
        loan: { min: 0, max: 5000000, required: true },
        deposit: { min: 0, max: 1000000, required: true },
        expenses: { min: 0, max: 50000, required: true }
      };
      
      // Real-time validation
      inputs.forEach(input => {
        input.addEventListener('input', validateField);
        input.addEventListener('blur', validateField);
      });
      
      // Form submission
      form.addEventListener('submit', function(e) {
        let isValid = true;
        
        inputs.forEach(input => {
          if (!validateField.call(input)) {
            isValid = false;
          }
        });
        
        if (!isValid) {
          e.preventDefault();
          showError('Please correct all errors before submitting.');
        }
      });
      
      function validateField() {
        const field = this;
        const name = field.name;
        const value = field.value.trim();
        const rule = rules[name];
        
        clearError(field);
        
        if (!value && rule.required) {
          showError(field, `${getLabel(name)} is required.`);
          return false;
        }
        
        if (value && isNaN(value)) {
          showError(field, `${getLabel(name)} must be a valid number.`);
          return false;
        }
        
        const numValue = parseFloat(value);
        if (numValue < rule.min) {
          showError(field, `${getLabel(name)} must be at least $${rule.min.toLocaleString()}.`);
          return false;
        }
        
        if (numValue > rule.max) {
          showError(field, `${getLabel(name)} cannot exceed $${rule.max.toLocaleString()}.`);
          return false;
        }
        
        // Business rules
        if (name === 'income' && numValue <= 0) {
          showError(field, 'Monthly income must be greater than $0.');
          return false;
        }
        
        if (name === 'loan' && numValue <= 0) {
          showError(field, 'Loan amount must be greater than $0.');
          return false;
        }
        
        return true;
      }
      
      function showError(field, message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.textContent = message;
        
        if (field.parentNode.querySelector('.field-error')) {
          field.parentNode.querySelector('.field-error').remove();
        }
        
        field.parentNode.appendChild(errorDiv);
        field.classList.add('error');
      }
      
      function clearError(field) {
        const errorDiv = field.parentNode.querySelector('.field-error');
        if (errorDiv) {
          errorDiv.remove();
        }
        field.classList.remove('error');
      }
      
      function getLabel(name) {
        const labels = {
          income: 'Monthly income',
          loan: 'Loan amount',
          deposit: 'Deposit amount',
          expenses: 'Monthly expenses'
        };
        return labels[name] || name;
      }
      
      // Input sanitization
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          let value = this.value;
          // Remove non-numeric characters except decimal point and minus
          value = value.replace(/[^0-9.-]/g, '');
          
          // Ensure only one decimal point
          const parts = value.split('.');
          if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
          }
          
          // Ensure minus only at the beginning
          if (value.indexOf('-') > 0) {
            value = value.replace(/-/g, '');
          }
          
          this.value = value;
        });
      });
    });
  </script>
</body>
</html>
